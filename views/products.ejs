<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Catalog</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-item"><a href="/">All Products</a></div>
        <% if (typeof hierarchy !== 'undefined' && Object.keys(hierarchy).length > 0) { %>
            <% Object.keys(hierarchy).forEach(family => { %>
                <div class="nav-item dropdown">
                    <a href="/?family=<%= encodeURIComponent(family) %>" class="dropbtn"><%= family %></a>
                    <div class="dropdown-content">
                        <a href="/?family=<%= encodeURIComponent(family) %>">All <%= family %></a>
                        <% Object.keys(hierarchy[family]).forEach(productType => { %>
                            <a href="/?family=<%= encodeURIComponent(family) %>&type=<%= encodeURIComponent(productType) %>"><%= productType %></a>
                        <% }); %>
                    </div>
                </div>
            <% }); %>
        <% } %>
    </nav>

    <div class="container">
        <div id="sidebar">
            <div class="available-tags">
                <strong>Available Tags:</strong> <% /* Removed Top 30 */ %>
                <% if (typeof displayTags !== 'undefined' && displayTags.length > 0) { %>
                    <ul> <% /* Use a list for better structure/scrolling */ %>
                    <% displayTags.forEach(tagInfo => { %>
                        <% 
                            // Create URL to ADD this tag (keeping others)
                            const addTagUrlParams = new URLSearchParams();
                            (currentTags || []).forEach(t => addTagUrlParams.append('tag', t)); // Keep existing
                            let isAlreadySelected = (currentTags || []).includes(tagInfo.tag);
                            if (!isAlreadySelected) { // Only add if not already present
                               addTagUrlParams.append('tag', tagInfo.tag); // Add new one
                            }
                            // Add class if dynamic count is zero OR tag is already selected
                            const tagLinkClass = (tagInfo.dynamicCount === 0 && !isAlreadySelected) || isAlreadySelected ? 'tag-link zero-count' : 'tag-link';

                            // Determine if the tag should be shown
                            const showTag = tagInfo.dynamicCount > 0 || isAlreadySelected;
                        %>
                        <% if (showTag) { %> <% /* Only render if dynamic count > 0 OR already selected */ %>
                            <li>
                            <a href="/?<%= addTagUrlParams.toString() %>" class="<%= tagLinkClass %>">
                                <span class="tag"><%= tagInfo.tag %> (<%= tagInfo.dynamicCount %>)</span>
                            </a>
                            </li>
                        <% } %>
                    <% }); %>
                    </ul>
                <% } else { %>
                    <span>None</span>
                <% } %>
            </div>
        </div>

        <div id="main-product-area">
            <div class="filter-info">
                <% if (typeof currentTags !== 'undefined' && currentTags.length > 0) { %>
                    <span class="current-filter-label">Filtering by Tags:</span>
                    <div class="current-filter-tags-container">
                        <% currentTags.forEach(tag => { %>
                            <div class="current-filter-tag">
                                <% 
                                    // Create URL to remove *this* tag
                                    const removeTagUrlParams = new URLSearchParams();
                                    currentTags.forEach(t => {
                                        if (t !== tag) { // Keep other tags
                                            removeTagUrlParams.append('tag', t);
                                        }
                                    });
                                %>
                                <a href="/?<%= removeTagUrlParams.toString() %>" class="clear-filter-x">&#x2716;</a>
                                <span class="tag"><%= tag %></span>
                            </div>
                        <% }); %>
                    </div>
                <% } else if (typeof currentFamily !== 'undefined' && currentFamily) { %>
                    <span class="current-filter">Filtering by Family: <strong><%= currentFamily %></strong><% if (currentType) { %> / Type: <strong><%= currentType %></strong><% } %> 
                        <% /* Update clear link for family/type */ %>
                        <a href="/" class="clear-filter">(x)</a>
                    </span>
                <% } %>
            </div>

            <h1>Kinetic Constructs - Product Catalog</h1>

            <% if (error) { %>
                <p class="error">Error: <%= error %></p>
            <% } else if (products && products.length > 0) { %>
                <div class="product-grid">
                    <% products.forEach(product => { %>
                        <div class="product-card">
                            <h2><%= product.name %></h2>
                            <% if (product.image_url) { %>
                                <img src="<%= product.image_url %>" alt="<%= product.name %>" class="product-image">
                            <% } else { %>
                                 <div class="product-image placeholder">No Image</div>
                            <% } %>
                            <p><%= product.description %></p>
                            <p class="price">Price: <%= product.price?.currency %> <%= product.price?.amount %></p>
                            
                            <% if (product.tags && product.tags.length > 0) { %>
                                <div class="tags">
                                    <% product.tags.forEach(tag => { %>
                                        <% 
                                            // Create URL to ADD this tag (keeping others)
                                            const addCardTagUrlParams = new URLSearchParams();
                                            (currentTags || []).forEach(t => addCardTagUrlParams.append('tag', t)); // Keep existing
                                            if (!(currentTags || []).includes(tag)) {
                                                addCardTagUrlParams.append('tag', tag); // Add new one
                                            }
                                        %>
                                        <a href="/?<%= addCardTagUrlParams.toString() %>" class="tag-link"><span class="tag"><%= tag %></span></a>
                                    <% }); %>
                                </div>
                            <% } %>

                            <%# Moved Family and Product Type to bottom, used DL %>
                            <div class="product-meta">
                                <dl>
                                    <dt>Family:</dt>
                                    <dd><a href="/?family=<%= encodeURIComponent(product.family) %>" class="meta-link"><%= product.family %></a></dd>
                                    <dt>Type:</dt>
                                    <dd><a href="/?family=<%= encodeURIComponent(product.family) %>&type=<%= encodeURIComponent(product.product_type) %>" class="meta-link"><%= product.product_type %></a></dd>
                                </dl>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <p>No products found.</p>
            <% } %>
        </div> <% /* End #main-product-area */ %>
    </div> <% /* End .container */ %>

</body>
</html> 